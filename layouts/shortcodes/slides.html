{{/*
  Slides shortcode - Embeds reveal-hugo slides directly on the page (no iframe)

  Uses reveal-hugo partials with full plugin support. Responsive behavior via reveal.js 5.0:
  - Mobile (<sm): Scroll view with swipe navigation
  - Desktop (≥sm): Classic view with arrow controls + keyboard

  Shortcode Parameters:
    src:      (required) path to slide page, e.g., "slides/para-welcome-kit"
    height:   (optional) container height, defaults to "500px"
    overview: (optional) enable O key for overview mode, defaults to "true"
    notes:    (optional) enable S key for speaker notes, defaults to "true"

  Slide Page Settings (from front matter reveal_hugo.*):
    reveal_cdn, highlight_cdn     - asset locations (default: reveal-js, highlight-js)
    theme, highlight_theme        - visual themes (default: black, monokai)
    custom_theme, custom_css      - custom theme/css paths
    transition                    - slide transition (default: slide)
    width, height                 - slide dimensions (default: 960x700)
    margin, min_scale, max_scale  - sizing (default: 0.04, 0.2, 2.0)
    center, controls, progress    - reveal.js options (default: true)
    load_default_plugins          - load highlight.js (default: true)

  Usage: {{< slides src="slides/para-welcome-kit" height="600px" >}}

  Requires: github.com/joshed-io/reveal-hugo module
  Styles:   assets/css/slides.css
*/}}

{{/* Fail build if reveal-hugo module is not installed */}}
{{- if not (templates.Exists "partials/reveal-hugo/slides.html") -}}
  {{- errorf "slides shortcode requires reveal-hugo module. Add to hugo.yaml: module.imports: [{path: github.com/joshed-io/reveal-hugo}] then run: hugo mod get -u" -}}
{{- end -}}

{{- $src := .Get "src" | strings.TrimSuffix "/" -}}
{{- $height := .Get "height" | default "500px" -}}
{{- $overview := ne (.Get "overview") "false" -}}
{{- $notes := ne (.Get "notes") "false" -}}
{{- $id := printf "reveal-%s" (md5 $src) -}}

{{/* Get the slides page */}}
{{- $slidesPage := site.GetPage (printf "/%s" $src) -}}

{{- if $slidesPage -}}

{{/* Get reveal-hugo settings from the slides page - matching layout/theme.html logic */}}
{{- $reveal_location := $slidesPage.Param "reveal_hugo.reveal_cdn" | default "reveal-js" -}}
{{- $highlight_location := $slidesPage.Param "reveal_hugo.highlight_cdn" | default "highlight-js" -}}
{{- $theme := $slidesPage.Param "reveal_hugo.theme" | default "black" -}}
{{- $highlight_theme := $slidesPage.Param "reveal_hugo.highlight_theme" | default "monokai" -}}
{{- $transition := $slidesPage.Param "reveal_hugo.transition" | default "slide" -}}
{{- $custom_theme := $slidesPage.Param "reveal_hugo.custom_theme" -}}
{{- $custom_css := $slidesPage.Param "reveal_hugo.custom_css" -}}
{{/* Presentation sizing - https://revealjs.com/presentation-size/ */}}
{{- $width := $slidesPage.Param "reveal_hugo.width" | default 960 -}}
{{- $slideHeight := $slidesPage.Param "reveal_hugo.height" | default 700 -}}
{{- $margin := $slidesPage.Param "reveal_hugo.margin" | default 0.04 -}}
{{- $minScale := $slidesPage.Param "reveal_hugo.min_scale" | default 0.2 -}}
{{- $maxScale := $slidesPage.Param "reveal_hugo.max_scale" | default 2.0 -}}

{{/* Get plugins - reveal-hugo's internal/plugins partial has a bug where it fails when
     load_default_plugins: false and no custom plugins are defined (tries to sort empty sequence).
     We skip calling it entirely when load_default_plugins is explicitly false. */}}
{{- $plugins := slice -}}
{{- $loadDefaultPlugins := $slidesPage.Param "reveal_hugo.load_default_plugins" -}}
{{- if ne $loadDefaultPlugins false -}}
  {{/* Only call reveal-hugo's partial when defaults are enabled or not specified */}}
  {{- with partial "internal/plugins" $slidesPage -}}
    {{- $plugins = . -}}
  {{- end -}}
{{- end -}}
{{/* Filter out notes plugin if notes are disabled */}}
{{- if not $notes -}}
  {{- $filteredPlugins := slice -}}
  {{- range $plugins -}}
    {{- if ne .name "RevealNotes" -}}
      {{- $filteredPlugins = $filteredPlugins | append . -}}
    {{- end -}}
  {{- end -}}
  {{- $plugins = $filteredPlugins -}}
{{- end -}}

<div class="slides-inline-container" style="--slide-width: {{ $width }}; --slide-height: {{ $slideHeight }};">

  {{/* Bundle reveal.js CSS - eliminates render-blocking @import waterfall */}}
  {{- $cssContent := "" -}}
  {{/* Note: We skip reveal.js theme fonts (Source Sans Pro) since site uses Inter font */}}
  {{- with resources.Get (printf "%s/dist/reveal.css" $reveal_location) -}}
    {{- $cssContent = printf "%s%s" $cssContent .Content -}}
  {{- end -}}
  {{- if $custom_theme -}}
    {{- with resources.Get $custom_theme -}}
      {{- $cssContent = printf "%s%s" $cssContent .Content -}}
    {{- end -}}
  {{- else -}}
    {{- with resources.Get (printf "%s/dist/theme/%s.css" $reveal_location $theme) -}}
      {{/* Strip @import for theme fonts - site uses Inter, not Source Sans Pro */}}
      {{- $themeCSS := .Content | replaceRE `@import[^;]+;` "" -}}
      {{- $cssContent = printf "%s%s" $cssContent $themeCSS -}}
    {{- end -}}
  {{- end -}}
  {{/* Only load highlight.js CSS if RevealHighlight plugin is enabled */}}
  {{- $hasHighlight := false -}}
  {{- range $plugins -}}
    {{- if eq .name "RevealHighlight" -}}
      {{- $hasHighlight = true -}}
    {{- end -}}
  {{- end -}}
  {{- if $hasHighlight -}}
    {{- with resources.Get (printf "%s/%s.min.css" $highlight_location $highlight_theme) -}}
      {{- $cssContent = printf "%s%s" $cssContent .Content -}}
    {{- end -}}
  {{- end -}}
  {{- if $custom_css -}}
    {{- with resources.Get $custom_css -}}
      {{- $cssContent = printf "%s%s" $cssContent .Content -}}
    {{- end -}}
  {{- end -}}
  {{- range $plugins -}}
    {{- with .css -}}
      {{- with resources.Get . -}}
        {{- $cssContent = printf "%s%s" $cssContent .Content -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- $bundledCSS := $cssContent | resources.FromString (printf "css/reveal-%s.css" $id) -}}
  {{- if not hugo.IsDevelopment -}}
    {{- $bundledCSS = $bundledCSS | resources.Minify | resources.Fingerprint "sha256" -}}
  {{- end -}}
  {{/* External CSS with fingerprint in production for caching; inline in dev for speed */}}
  {{- if hugo.IsDevelopment -}}
    <style>{{ $bundledCSS.Content | safeCSS }}</style>
  {{- else -}}
    <link rel="stylesheet" href="{{ $bundledCSS.RelPermalink }}"{{ with $bundledCSS.Data.Integrity }} integrity="{{ . }}"{{ end }}>
  {{- end -}}

  {{/* Render slides and fix relative image paths */}}
  {{- $slidesContent := partial "reveal-hugo/slides" (slice $slidesPage) -}}
  {{- $slidesContent = $slidesContent | replaceRE `data-background-image="([^/][^"]+)"` (printf `data-background-image="/%s/$1"` $src) -}}
  {{- $resourcesContent := partial "reveal-hugo/slides" ($slidesPage.Resources.ByType "page") -}}
  {{- $resourcesContent = $resourcesContent | replaceRE `data-background-image="([^/][^"]+)"` (printf `data-background-image="/%s/$1"` $src) -}}

  <div id="{{ $id }}" class="slides-wrapper" tabindex="0">
    <div class="reveal">
      <div class="slides">
        {{- $slidesContent | safeHTML -}}
        {{- $resourcesContent | safeHTML -}}
      </div>
      <button class="fullscreen-btn" title="Toggle fullscreen">
        <svg class="expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
        <svg class="collapse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
        </svg>
      </button>
    </div>
  </div>

  <p class="slides-legend text-neutral-500">
    <kbd onclick="document.getElementById('{{ $id }}').revealdeck.prev()" title="Previous slide">←</kbd><kbd onclick="document.getElementById('{{ $id }}').revealdeck.next()" title="Next slide">→</kbd> navigate
    · <kbd onclick="(function(el){if(el.requestFullscreen)el.requestFullscreen();else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();else if(el.msRequestFullscreen)el.msRequestFullscreen();})(document.getElementById('{{ $id }}'))" title="Fullscreen">F</kbd> fullscreen
    {{- if $overview }}
    · <kbd onclick="document.getElementById('{{ $id }}').revealdeck.toggleOverview()" title="Toggle overview">O</kbd> overview
    {{- end }}
    {{- if $notes }}
    · <kbd onclick="(function(d){var n=d.revealdeck.getPlugin('notes');if(n&&n.open)n.open();else console.warn('Notes plugin not available');})(document.getElementById('{{ $id }}'))" title="Speaker notes">S</kbd> speaker notes
    {{- end }}
  </p>

  {{/* Bundle reveal.js core + plugins - reduces network requests from N to 1 */}}
  {{- $jsContent := "" -}}
  {{- with resources.Get (printf "%s/dist/reveal.js" $reveal_location) -}}
    {{- $jsContent = .Content -}}
  {{- end -}}
  {{- range $plugins -}}
    {{- with resources.Get .source -}}
      {{- $jsContent = printf "%s\n%s" $jsContent .Content -}}
    {{- end -}}
  {{- end -}}
  {{- $bundledJS := $jsContent | resources.FromString (printf "js/reveal-%s.js" $id) -}}
  {{- if not hugo.IsDevelopment -}}
    {{- $bundledJS = $bundledJS | resources.Minify | resources.Fingerprint "sha256" -}}
  {{- end -}}
  <script src="{{ $bundledJS.RelPermalink }}"{{ with $bundledJS.Data.Integrity }} integrity="{{ . }}"{{ end }}></script>

  <script>
    (function() {
      var container = document.getElementById('{{ $id }}');
      var revealEl = container.querySelector('.reveal');

      // Read Tailwind sm breakpoint from CSS variable (defined in custom.css)
      // Let browser convert any CSS unit (rem/em/px/etc) to pixels via temp element
      var temp = document.createElement('div');
      temp.style.width = 'var(--screen-sm)';
      temp.style.position = 'absolute';
      temp.style.visibility = 'hidden';
      document.body.appendChild(temp);
      var screenSm = temp.offsetWidth || 640;
      document.body.removeChild(temp);

      // https://revealjs.com/presentation-size/#embedded
      var deck = new Reveal(revealEl, {
        embedded: true,
        touch: true,
        width: {{ $width }},
        height: {{ $slideHeight }},
        margin: {{ $margin }},
        minScale: {{ $minScale }},
        maxScale: {{ $maxScale }},
        // Auto scroll view on mobile (<sm), classic on desktop: https://revealjs.com/scroll-view/
        scrollActivationWidth: screenSm,
        scrollLayout: 'compact',
        center: {{ $slidesPage.Param "reveal_hugo.center" | default true }},
        controls: {{ $slidesPage.Param "reveal_hugo.controls" | default true }},
        progress: {{ $slidesPage.Param "reveal_hugo.progress" | default true }},
        history: false,
        transition: '{{ $transition }}',
        keyboard: false,
        {{- $pluginNames := slice -}}
        {{- range $plugins -}}
          {{- $pluginNames = $pluginNames | append .name -}}
        {{- end }}
        plugins: {{ printf "%s" (replace (jsonify $pluginNames) "\"" "") | safeJS }}
      });
      deck.initialize();

      // Recalculate layout on fullscreen change
      document.addEventListener('fullscreenchange', function() {
        if (document.fullscreenElement === container || !document.fullscreenElement) {
          deck.layout();
        }
      });

      // Expose deck on container element for onclick handlers
      container.revealdeck = deck;

      // Check if the slide container is visible in the viewport
      function isInViewport(el) {
        var rect = el.getBoundingClientRect();
        var windowHeight = window.innerHeight || document.documentElement.clientHeight;
        var visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
        return visibleHeight > rect.height * 0.2;
      }

      // Global keyboard handler
      document.addEventListener('keydown', function(e) {
        if (!isInViewport(container)) return;
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

        switch(e.key) {
          case 'ArrowRight':
            e.preventDefault();
            deck.next();
            break;
          case 'ArrowLeft':
            e.preventDefault();
            deck.prev();
            break;
          case 'ArrowUp':
            e.preventDefault();
            deck.up();
            break;
          case 'ArrowDown':
            e.preventDefault();
            deck.down();
            break;
          case 'f':
          case 'F':
            e.preventDefault();
            if (container.requestFullscreen) container.requestFullscreen();
            else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
            else if (container.msRequestFullscreen) container.msRequestFullscreen();
            break;
          {{- if $notes }}
          case 's':
          case 'S':
            e.preventDefault();
            var notesPlugin = deck.getPlugin('notes');
            if (notesPlugin && notesPlugin.open) {
              notesPlugin.open();
            } else {
              console.warn('Notes plugin not available');
            }
            break;
          {{- end }}
          {{- if $overview }}
          case 'o':
          case 'O':
            e.preventDefault();
            deck.toggleOverview();
            break;
          {{- end }}
          case 'Escape':
            if (document.fullscreenElement === container) {
              document.exitFullscreen();
            }
            {{- if $overview }}
            else if (deck.isOverview()) {
              deck.toggleOverview();
            }
            {{- end }}
            break;
        }
      });

      container.addEventListener('click', function() {
        this.focus();
      });

      // Hide fullscreen button if inside iframe (e.g., speaker notes view)
      if (window.self !== window.top) {
        var fsBtn = container.querySelector('.fullscreen-btn');
        if (fsBtn) fsBtn.style.display = 'none';
      }

      // Fullscreen button handler
      container.querySelector('.fullscreen-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        if (document.fullscreenElement === container) {
          document.exitFullscreen();
        } else {
          if (container.requestFullscreen) container.requestFullscreen();
          else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
          else if (container.msRequestFullscreen) container.msRequestFullscreen();
        }
      });
    })();
  </script>
</div>

{{- else -}}
<div class="p-4 bg-red-100 text-red-700 rounded">
  <p>Slides not found at: /{{ $src }}/</p>
</div>
{{- end -}}