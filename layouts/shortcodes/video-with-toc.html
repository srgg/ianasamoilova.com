{{/*
  Video with Table of Contents shortcode

  Displays video with a chapter navigation panel on the right (desktop) or below (mobile).
  Chapters defined in front matter with hierarchy support.

  Front matter format:
    video_chapters:
      - title: "Getting Started"
        time: 0
        children:
          - title: "Introduction"
            time: 0
          - title: "Registration"
            time: 30
      - title: "Creating Content"
        time: 90

  Parameters:
    src:      (required) video filename
    poster:   (optional) thumbnail image
    id:       (optional) video element id, defaults to "chapter-video"

  Usage:
    video-with-toc src="tutorial.mp4"
*/}}

{{- $src := .Get "src" -}}
{{- $poster := .Get "poster" -}}
{{- $id := .Get "id" | default "chapter-video" -}}
{{- $chapters := .Page.Params.video_chapters -}}

{{/* Resolve video source */}}
{{- $video_ext := path.Ext $src -}}
{{- $video_type := strings.TrimPrefix "." $video_ext -}}
{{- $asset := (.Page.Resources.ByType "video").GetMatch $src -}}
{{- if not $asset -}}
  {{- $asset = resources.Get (path.Join "media" $src) -}}
{{- end -}}
{{- $videoURL := $src -}}
{{- if $asset -}}
  {{- $videoURL = $asset.RelPermalink -}}
{{- end -}}

{{/* Resolve poster */}}
{{- $posterURL := "" -}}
{{- if $poster -}}
  {{- $posterAsset := (.Page.Resources.ByType "image").GetMatch $poster -}}
  {{- if not $posterAsset -}}
    {{- $posterAsset = resources.Get (path.Join "media" $poster) -}}
  {{- end -}}
  {{- if $posterAsset -}}
    {{- $posterURL = $posterAsset.RelPermalink -}}
  {{- else -}}
    {{- $posterURL = $poster -}}
  {{- end -}}
{{- end -}}

<div class="video-toc-container flex flex-col lg:flex-row gap-2 lg:gap-6 my-6">
  {{/* Video */}}
  <div class="video-wrapper flex-1 min-w-0">
    <video id="{{ $id }}" controls class="w-full rounded-lg shadow-lg" style="margin: 0;"{{ with $posterURL }} poster="{{ . }}"{{ end }}>
      <source src="{{ $videoURL }}" type="video/{{ $video_type }}">
      Your browser does not support the video tag.
    </video>
  </div>

  {{/* Chapter TOC */}}
  {{- with $chapters -}}
  <nav class="video-toc not-prose w-full lg:w-78 shrink-0 flex flex-col" aria-label="video chapters">
    <div class="bg-gray-50 dark:bg-neutral-800 rounded-lg px-4 pb-4 pt-2 flex-1">
      <p class="font-semibold tracking-tight text-gray-900 dark:text-gray-100" style="margin-top: 0 !important; margin-bottom: 0.2em !important;">Chapters</p>
      <ul class="space-y-1 text-sm" style="list-style: none; margin-top: 0; margin-bottom: 0; padding-left: 0;">
        {{- range . -}}
          {{- template "video-chapter" (dict "chapter" . "level" 0 "videoId" $id) -}}
        {{- end -}}
      </ul>
    </div>
  </nav>
  {{- end -}}
</div>

{{/* Chapter item template */}}
{{- define "video-chapter" -}}
  {{- $chapter := .chapter -}}
  {{- $level := .level -}}
  {{- $videoId := .videoId -}}
  {{- $indent := mul $level 12 -}}
  <li style="line-height: 1; margin: 0;">
    <a href="#"
       onclick="document.getElementById('{{ $videoId }}').currentTime={{ $chapter.time }}; document.getElementById('{{ $videoId }}').play(); return false;"
       class="video-chapter-link flex items-center gap-2 px-2 -mx-2 rounded transition-colors
              text-gray-600 hover:text-gray-900 hover:bg-gray-100
              dark:text-gray-400 dark:hover:text-gray-100 dark:hover:bg-neutral-700"
       style="padding-bottom: 6px;{{ if eq $level 0 }} font-weight: 500;{{ end }}"
       data-time="{{ $chapter.time }}">
      <span class="chapter-time text-xs text-gray-400 dark:text-gray-500 tabular-nums" style="width: 2.5rem; flex-shrink: 0;">
        {{- $minutes := div $chapter.time 60 -}}
        {{- $seconds := mod $chapter.time 60 -}}
        {{- printf "%d:%02d" $minutes $seconds -}}
      </span>
      <span class="chapter-title"{{ if gt $level 0 }} style="padding-left: {{ $indent }}px;"{{ end }}>{{ $chapter.title }}</span>
    </a>

    {{- with $chapter.children -}}
      <ul class="mt-1 space-y-1" style="list-style: none; margin-top: 0; margin-bottom: 0; padding-left: 0;">
        {{- range . -}}
          {{- template "video-chapter" (dict "chapter" . "level" (add $level 1) "videoId" $videoId) -}}
        {{- end -}}
      </ul>
    {{- end -}}
  </li>
{{- end -}}